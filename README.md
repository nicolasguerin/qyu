# qyu

In-memory queue library in JavaScript, with maximum processing jobs limit and recurrent stats.
You can use demo.js as an example.

## Installation

### Qyu library

Not distributed over npm. Please download source code.

### Test using mocha

Install mocha

```
npm install mocha
```

Run unit tests
```
npm test
```

## API description

### Initialisation and control

#### Create a Qyu

How to import module, create and initialise a new 'Qyu'.
It could take several parameters, otherwise values are set to default.

* rateLimit (default value : 20) - Maximum number of jobs being processed at the same time
* statsInterval (default value : 300) - When stat event is sent, in ms.

```js
const qyu = require('./qyu');

const q = new qyu({
  rateLimit: 10, // maximum number of jobs being processed at the same time
  statsInterval: 2000 // When stat event is sent, in ms
});
```

#### Pushing a job

How to push any kind of function into the 'Qyu'. 
It takes two parameters. Return value is a unique job id.

* job (mandatory) - A function that will be asynchronously executed.
* priority (default value : 5) - Optional priority, from 1 to 10, 1 being the highest priority. If value specified above 10, value is set to the lowest priority 10.

```js
const id = q.push(
    job, // function to execute
    3,   // optional priority, from 1 to 10, 1 being the highest priority - default: 5
  ); // returns the internal id
```

#### Start the 'Qyu'

How to start processing jobs that have been pushed into the 'Qyu'.
It returns a promise resolved when 'q' has started (first time) or unpaused.

```js
await q.start(); // returns a promise resolved when `q` has started (first time) or unpaused
```

#### Pause the 'Qyu'

How to pause jobs processing.
It returns a promise resolved when 'q' has paused (no jobs being processed).

```js
await q.pause(); // returns a promise resolved when `q` has paused (no jobs being processed)
```

#### Wait for a job to complete

How to wait for a job to complete.
A promise resolves when the job is complete with the job result.

```js
const res = await q.wait(id); // resolves when the job is complete with the job result
```


### Qyu events

#### Job done

Event thrown when a job is complete.

```js
q.on('done', ({ id, result }) => {
  console.log(`Job done ${id}`); // `id` is an internal identifier generated by `qyu`
  console.log("result : " + result.Hello);
});
```

#### Job error

Event thrown when an error occured during job execution.

```js
q.on('error', ({ id, error }) => {
  console.log(`Job ${id} threw an error: ${error.message}`);
});
```

#### Qyu drain

Event thrown when the 'Qyu' is drained;

```js
q.on('drain', () => {
  console.log('No more jobs to do');
});
```

#### Qyu stats

Event thrown reccurently depending on 'statsInterval', giving number of jobs processed per second.

```js
q.on('stats', ({ nbJobsPerSecond }) => {
  console.log(`${nbJobsPerSecond} jobs/s processed`);
});
```


### Qyu data exposed

#### Get rate limit

Returns the rate limit set at initialisation.

```js
var limit = q.getRateLimit(); // returns the rate limit set at initialisation
```

#### Get stats interval

Returns the stats interval set at initialisation.

```js
var statsInterval = q.getStatsInterval(); // returns the stats interval set at initialisation
```

#### Get qyu length

Returns queue length.

```js
var length = q.qetQyuLength(); // returns queue length
```

#### Check if Qyu is started

Returns a boolean, true if the queue has been started.

```js
var isStarted = q.isQyuStarted(); // returns a boolean, true if the queue has been started.
```

#### Get job priority

Returns priority of a job.

```js
var priority = q.getJobPriority(); // returns priority of a job
```


